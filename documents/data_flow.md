# Recursive Yak Shaver: データの流れとインターフェース
# 目的: システム内部のデータ遷移、キャッシュ機構、LLMとの連携仕様。
# 更新履歴: 1.1 (2026-02-24)

## キャッシュと永続化 (Persistence)
RYS は、各フェーズの結果を XDG キャッシュディレクトリ（デフォルト: `~/.cache/rys/`）内の JSON ファイルとして永続化する。

### ファイル命名規則
キャッシュファイルは以下の形式で生成される。
`${RYS_CACHE_DIR}/.cache.p<Phase番号>.<Hash>.json`
- **Hash**: 入力データやスキルの設定状況から算出された MD5 ハッシュ。
- **UUID**: プロセスの追跡に使用される識別子。

### フェーズ間データフロー (P1-P6)
1. **P1 (Translation)**: 翻訳済みプロンプトを渡す。
2. **P2 (Dispatch)**: タスク (Task) のリストと割り当てスキル情報を渡す。
3. **P3 (Grouping)**: 依存関係に基づき整理されたジョブ (Job) のリストを渡す。
4. **P4 (Processing)**: 各ジョブのタスクに対する詳細 I/O、ループ、パターンの「ヒント」を渡す。
5. **P5 (Generation)**: 生成されたスクリプトのパス (`.sh` または `.py`) を渡す。
6. **P6 (Execution)**: スクリプトの実行結果を表示し、完了を報告する。

## LLM インターフェース
LLM との通信は `rys/chat_api.py` および `rys/chat_core.py` が担当し、OpenAI 互換 API を使用する。

### 通信仕様
- **Streaming**: `urllib` を用いた SSE (Server-Sent Events) のストリーム解析を行い、リアルタイムでの応答表示をサポート。
- **TOON 形式**: プロンプト内での構造データ表現に採用。詳細は [roles_and_skills.md](./roles_and_skills.md) を参照。

## エラー処理
- 致命的なエラー（API 接続失敗、構文エラーなど）は標準エラー出力 (`stderr`) に出力し、プロセスを終了する。
- 例外ベースのエラーハンドリングを行い、上位フェーズで適切にキャッチして報告する。
