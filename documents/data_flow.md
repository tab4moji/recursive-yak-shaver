# Recursive Yak Shaver: データの流れとインターフェース
# プロジェクト目的: システム内部のデータ遷移と外部APIとの連携仕様。
# 更新履歴: 1.0 (2026-02-17)

## データの流れ (Data Flow)
RYS は、各フェーズの結果を `tmp/` ディレクトリ内の JSON ファイルとして永続化する。これによって、エラー発生時の再開（レジューム）や、特定のフェーズからの再実行が可能となっている。

### ファイル命名規則
キャッシュファイルは以下の形式で生成される。
`tmp/.cache.p<Phase番号>.<Hash>.json`
- **Hash**: 入力データやスキルの設定状況から算出された MD5 ハッシュ。
- **UUID**: プロセスの追跡に使用される識別子。

### フェーズ間連携
1. **P1 (Translate)** -> **P2 (Dispatch)**: 正規化されたテキストを渡す。
2. **P2 (Dispatch)** -> **P3 (Group)**: タスク分解リストと割り当てスキル情報を渡す。
3. **P3 (Group)** -> **P4 (Request)**: グループ化されたタスクリストを渡す。
4. **P4 (Request)** -> **P5 (Generate)**: 具体的な実行パラメータを含む詳細リクエストを渡す。
5. **P5 (Generate)** -> **P6 (Execute)**: 生成されたスクリプトのパスと実行コマンドを渡す。

## LLM インターフェース
LLM との通信は `rys/chat_api.py` および `rys/chat_core.py` が担当する。

### 通信仕様
- **OpenAI 互換 API**: `v1/chat/completions` エンドポイントを使用。
- **Streaming**: `urllib` を用いた SSE (Server-Sent Events) のストリーム解析を行い、リアルタイムでの応答表示をサポート。
- **Multimodal**: 画像入力 (`/image` コマンド) に対応し、Base64 エンコードによる Vision API 連携が可能。
- **接続性**: `verify_connection` によって実行前に API の疎通を確認する。

## エラー処理
- 早期リターンを避け、例外ベースのエラーハンドリングを行う。
- 致命的なエラー（API 接続失敗、構文エラーなど）は標準エラー出力 (`stderr`) に出力し、プロセスを終了する。
